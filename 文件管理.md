# 一、文件管理

操作系统中得文件系统 **专门负责管理外存储器上得信息** ，用户可以使用“按名”高效、快速和方便地存储信息。

## 1.1 基本概念

### 1.1.1 文件

文件(File)是具有符号名的、在逻辑上具有完整意义的一组相关信息集合。；例如，源程序、目标程序、编译程序、待加工数据、各类文当等都可以各自组成一个文件。

信息项时构成文件内容的基本单位，可以是一个字符，也可以是一个记录(可以等长，也可以不等长)。文件 **包括文件体(真实内容)和文件说明(操作系统管理文件使用的信息，包括文件名、文件内部标识、文件的类型、文件存储地址、文件的长度、访问权限、建立时间、访问时间等)** 。

文件时一种抽象机制，隐藏了硬件和实现细节，提供了将信息保存在磁盘上并进行读取的手段，使用户不必了解信息存储的方法、位置以及存储设备的实际操作方式。操作系统通过文件名对文件进行控制和管理。不同的操作系统文件的命名规范有所不同，文件名的格式和长度不同。

### 1.1.2 文件系统

文件系统时操作系统中实现文件统一管理的一组软件和相关数据的集合，专门负责管理和存取文件信息的软件机构。功能包括如下几个

1. 按名存取，用户可以**按名存取**，而不是**按地址存取**
2. 统一的用户接口，在不同设备上提供相同的接口，方便用户操作和编程
3. 并发访问和控制，多道系统中支持对文件的并发访问和控制
4. 安全性控制，在多用户系统中的不同用户对同一文件可有不同的访问权限
5. 优化性能，采用相关技术提高系统对文件的存储效率、检索和读写性能
6. 差错恢复，能够验证文件的正确性，并具有一定的差错恢复能力

### 1.1.3 文件分类

文件按照性质和用途、保存期限、保护方式等通常有如下分类
1. 按文件性质和用途分为**系统文件、库文件、用户文件**
2. 按信息保存期限可将文件分为**临时文件、档案文件、永久文件**
3. 按文件的保护方式分为**只读文件、读写文件、可执行文件、不保护文件**
4. UNIX系统将文件分为**普通文件、目录文件、设备文件**

文件分类的目的是对不同文件进行管理，提高系统效率以及用户界面友好性。还可以根据文件的存取方法和物理结构不同进行分类。

## 1.2 文件的结构和组织

文件的结构是指 **文件的组织形式** 。文件的 **逻辑结构** 是指用户只需要知道文件的文件名，不用知道这些文件存放在什么地方，就可以存取文件中的信息。文件的 **物理结构** 是指文件在文件存储器上的存放方式。

### 1.2.1 文件的逻辑结构

文件的逻辑结构可分为两大类：**记录式文件和流式文件**

1. **有结构的记录式文件**

    所有的记录通常都是描述一个实体集，有着相同或不同数目的数据项。记录长度可分**定长记录和不定长记录**两类
    * 定长记录。文件中所有记录的长度相同。所有记录中的各个数据项都处在记录中相同的位置，具有相同的顺序以及相同的长度，**文件的长度用记录数目表示**

    * 变长记录。文件中各个记录的长度不相同。一个记录中所包含的数据项数目可能不同，数据项本的长度不定。

2. **无结构的流式文件**

    文件体为字节流，不划分记录。通常采用顺序访问方式，并且每次读写访问可以指定任意的数据长度，以字节为单位。访问方式是**利用读写指针指出下一个要访问的字符**。在UNIX系统中所有文件都被看作流式文件，即使是有结构的文件也被视为流式文件，系统不对文件进行格式处理。

### 1.2.2 文件的物理结构

文件的物理结构是指文件的内部组织形式，即 **文件在物理存储设备上的存放方法。** 由于文件的物理结构决定了文件在存储设备上的存放位置，所以**文件的逻辑块号到物理块号的转换也是由文件的物理块号决定的。**常见的文件物理结构如下

1. **连续结构**，也称为顺序结构，将逻辑上连续的文件信息依次连续存放在连续编号的物理块上。
    * 只要知道文件的起始物理块号和文件长度，可以方便地进行文件存取
    * 对文件中地记录进行批量取出时，效率最高；对于删除或增加，效率较低。

2. **链接结构**，也称串结构，将逻辑上连续的文件信息存放在不连续地物理块上，每个物理块设置一个指向下一个物理块地指针。

3. **索引结构**，将逻辑上连续信文件息存放在不联系地物理块中，系统为每个文件建立一张索引表。索引表记录了文件信息所在地逻辑块号对应地物理块号，并将索引表地起始地址放在与文件的对应文件目录项中。

4. **多个物理块的索引表**，索引表是在文件创建时由系统自动创建，并与文件一起存放在同一文件卷上。索引表一般占用一个或几个物理块(一般采用链接文件或多重索引方式组织)
    
在UNIX文件系统中采用**三级索引结构**，文件系统中i-node是基本的构件，表示文件系统树形结构的特点。有**直接寻址、一级间接寻址、二级间接寻址、三级间接寻址**四种寻址方式

## 1.3 文件目录

系统为每个文件设置用于描述和控制文件的数据结构，至少包含文件名和存放文件的物理地址，这个数据结构称为文件控制块(FCB), 文件控制块(FCB)的有序集合称为文件目录。**文件目录是由文件控制块组成**，专门用于文件检索。FCB称为文件的说明或文件目录项。

### 1.3.1 文件控制块

文件控制块包含以下三类信息

1. **基本信息类**。如文件名、文件的物理地址、文件长度和文件块数等

2. **存取控制信息类**。文件的存取权限，如读、写、执行权限等

3. **使用信息类**。如文件建立日期、最后一次修改日期、最后一次访问日期、当前使用的信息、打开文件的进程数，在文件上的等待队列等

文件控制块的信息因操作系统不同而不同，UNIX系统中，FCB的各项信息为文件类型和存取权限、链接数、文件主、组名、文件长度、最后一次修改日期、文件名。

文件目录由文件控制块组成，专门用于文件的检索。文件目录可以存放在文件存储器固定位置，也可以以文件的形式存放在磁盘上，称为目录文件。

### 1.3.2 目录结构

文件目录结构的组织方式直接影响文件的存取速度，关系到文件共享性和安全性。常见的目录结构由如下3种

1. **一级目录结构**。目录组织是一个线性结构，整个系统只需要建立一张目录表，系统为每个文件分配一个目录项(文件控制块)。实现简单，查找速度慢，不允许重名和比便于文件共享

2. **二级目录结构**。由主文件目录(MFD)和用户文件目录(UFD)组成。在主文件目录中，每个用户文件目录都占一个目录项(文件控制块)，其目录项中包含用户名和指向该用户目录文件的指针。 **用户目录由用户所有文件的目录项组成。**
    * 提高了检索目录的速率
    * 较好地解决了重名问题
    * 有效地将多个用户隔开
    * 用户之间文件共享不便，多个用户合作完成一个大任务时，用户需要相互访问用户文件，隔离带来了此问题。

3. **多级目录结构**。像一颗倒置地有根树，从树根向下，每一个结点是一个目录，叶节点是文件。
    
    采用此目录结构地系统，用户访问文件必须指出文件所在地路径名(从根目录开始到该文件地通路上所有各级目录名拼接起来地到。各目录名之间，目录名与文件名之间需要用分隔符号隔开。Windows分隔符为“\”, UNIX分隔符为“/”)

## 1.4 存取方法、存取控制

### 1.4.1 文件的存放方法
文件的存取方法是指读写文件存储器上的一个物理块的方法，通常分为 **顺序读取和随机读取** 

1. **顺序读取**：对文件中信息按顺序依次读写的方式。在提供记录式文件结构的系统中，顺序读取法严格按物理记录排列的顺序依次读取。

2. **直接存取**：允许用户随意存取文件中一个物理记录。**无结构流式文件，必须事先移动到待读写信息的位置上再进行读写**

3. **按键存取**：是直接存取法的一种，根据文件中各记录的某个数据项内容来存取记录，数据项称为“键”


### 1.4.2 文件存储空间的管理

外部存储器具有大容量，能被多个用户共享的特点。用户经常要在磁盘上存储文件和删除文件，若要用户掌握磁盘空间哪些已经使用、哪些未使用，显然非常困难。文件系统对外存空间管理的数据结果通常称为磁盘分配表(Disk Allocation Table, DAT)。空闲空间的管理方法有**位示图、空闲区表、空闲块链**3种。

1. **空闲区表**。外存空间上一个连续未分配区域称为空闲区。操作系统为外存上所有空闲区建立一张空闲区表，每个表项对应一个空闲区，空闲区表中包含序号、空闲区的第一块号、空闲块的块数和状态等信息。 **它适用于连续文件结构** 。


2. **位示图**。在外存上建立一张位示表(Bitmap)，记录文件存储器的使用情况。每一位对应文件存储器上的物理块，取值0和1分别表示空闲和占用。物理块依次编号为0，1，2，...。

    位示图的大小由磁盘空间的大小(物理块总数)决定，例如，大小位120GB的磁盘，物理块的大小为4MB，则位示图大小为$120\times 1024 \div 4 \div 8=3840字节$

3. **空闲块链**。每个空闲物理块中有指向下一个物理块的指针，所有空闲物理块构成一个链表，链表的头指针在文件存储器的特定位置上(例如，管理块中)。不需要磁盘分配表，节省空间。每次申请空闲物理块只需要根据链表头指针取出第一个空闲物理块，根据第一个空闲物理块的指针找到第二空闲物理块，依此类推即可。

4. **成组链接法**。在UNIX系统中，将空闲块分成若干组，每100个空闲块为一组，每组的第一个空闲块登记下一组空闲块的物理块号和空闲块总数，假如一个组的第一个空闲块等于0，意味着该组是最后一组，无下一组空闲块。


## 1.5 文件的使用

文件系统将用户的逻辑文件按一定的组织方式转换成物理文件存入存储器，由文件系统为每个文件与其在磁盘上的存放位置建立起对应关系。当用户使用文件时，文件系统通过用户给出的文件名，查出对应文件的存放位置，读出文件的内容。

在多用户环境下，为了文件安全和保护，操作系统为每个文件建立和维护关于文件主、访问权限等方面的信息。为此，操作系统在操作级(命令级)和编程级(系统调用和函数)项用户提供文件服务。其中，在操作级向用户提供的命令有目录管理类命令、文件操作类命令(复制、删除、修改)和文件管理类命令(设置文件权限)等；编程级项用户提供的系统调用如下表

|系统调用|功能||系统调用|功能|
|:---:|:---:|:---:|---|:---:|:---:|
|`create(文件名, 参数表)`|创建文件||`close(文件名)`|关闭文件|
|`delete(文件名)`|撤销文件||`read(文件名, 参数表)`|读取文件|
|`open(文件名, 参数表)`|打开文件||`write(文件名)`|写入文件|



## 1.6 文件的共享和保护

### 1.6.1 文件的共享

文件的共享是指不同用户进程使用同一文件。 **不仅是不同用户完成同一任务所必需的功能，而且还可以节省大量的内存空间，减少由于文件复制而增加的访问外存次数** 。采用文件名和文件说明分离的目录结构有利于实现文件共享。在UNIX系统中允许多用户 **基于索引结点的共享** ，或 **利用符号链接共享同一文件** 。

符号链接是通过建立新的文件(或目录)与原文件(目录)的路径名映射。当访问符号链接时，系统通过该映射找到原来文件的路径，并进行访问。

采用符号链接可以跨越文件系统，只需要提供该文件所在的地址，以及在该机器上的文件路径，可以通过计算机网络链接到所有的机器中的文件。缺点是**其他用户读取符号链接的共享文件比读取硬链接的共享文件需要增加读盘操作次数。**

### 1.6.2 文件的保护

文件系统对文件的保护常 **采用存取控制的方式进行**。存取控制是指不同用户对文件的访问规定不同的权限，以防止文件被未经文件主同意的用户访问。文件保护方式有**存取控制矩阵、存取控制表、用户权限表、口令和密码**等

1. **存取控制矩阵**。一个二维矩阵，其中一维列车计算机中的全部用户，另一维列出系统中的全部文件。矩阵中每个元素$A_{ij}$表示第$i$个用户对第$j$个文件的存取权限。可读R、可写W、可执行X以及它们的组合表示文件的权限。当用户数和文件数很大时，占用很大的存储空间。

2. **存取控制表**。按用户对文件的访问权力的差别对用户进行分类，文件往往只与少部分用户关联。UNIX系统采用了存取控制表的方法

3. **用户权限表**。以用户和用户组为单位将用户可存取的文件集中起来存入表中，称为用户权限表。表中每个表目表示该用户对应文件的存取权限。

4. **密码**。创建文件时，用户提供一个密码，文件存入磁盘时用该密码对文件内容进行加密。进行读取操作时，要对文件进行解密，只有知道密码的用户才能读取文件。

## 1.7 系统的安全与可靠性

### 1.7.1 系统的安全

系统安全涉及两类不同问题**一类是技术、管理、法律、道德和政治等问题；另一类是操作系统的安全机制。**系统的安全性分为**系统级、用户级、目录级、文件级**4个级别对文件进行安全性管理

1. **系统级**。主要任务是 **不允许未经过核准的用户进入系统**，从而防止他人非法使用系统中的各类资源(包括文件)。系统级管理的主要措施有*注册和登录**

2. **用户级**。通过 **对所有用户分类和对指定用户分配访问权** 。不同用户对文件设置不同的存取权限来实现。UNIX系统中将用户分为文件主、组用户和其他用户。有的系统将用户分为**超级用户、系统操作员、一般用户**

3. **目录级**。为了保护系统中各种目录而设计，与用户权限无关。规定**只有系统核心才具有写目录的权限**

4. **文件级**。勇敢系统管理员或文件主对文件属性的设置来控制用户对文件的访问。通常可设置**只执行、隐含、只读、读/写、共享和系统属性**。用户对文件的访问，将由用户访问权、目录访问权限、文件属性三者的权限确定。**有效权限和文件属性的交集**


### 1.7.2 文件系统的可靠性

文件系统的可靠性是指系统抵抗和预防各种物理性破坏和人为破坏的能力。文件系统被破坏比计算机损坏更为严重，因为文件系统被破坏很大可能是不能恢复的。尽管文件系统无法防止设备和存储介质的物理损坏，但至少应能够保护信息

1. **转储和恢复**。文件系统中无论是硬件还是软件，都会发生损坏和错误。为了使文件系统保护信息完整，应采取相应的措施。例如，转储操作以形成文件或文件系统的多个副本。当系统出现故障时，利用转储数据可以恢复。常用的转储方法有**静态转储、动态转储、海量转储、增量转储**

2. **日志文件**。在计算机工作过程中，操作系统吧用户对文件的插入、删除、修改的操作写入日志文件。一旦出现故障，利用日志文件进行系统故障恢复，并可协助后备副本进行介质故障恢复。

3. **文件系统的一致性**。影响文件系统可靠性的因素之一时文件系统的一致性问题。很多文件系统是先读取磁盘块到内存，在内存中进行修改，修改完成再写回磁盘。如果读取某磁盘块并修改后写回磁盘前发生系统崩溃，则文件系统就会出现不一致状态。如果未被写回的磁盘块是索引块、目录块、空闲块，后果会更为严重。解决方案是**文件系统的一致性检查，包括块的一致性检查和文件的一致性检查**

