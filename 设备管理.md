# 一、设备管理

设备管理是操作系统中最繁杂且与硬件紧密相关的部分，不但要 **管理实际I/O操作的设备** (磁盘机、扫描义、打印机、鼠标和键盘)，还要 **管理设备控制器、DMA控制器、中断控制器和I/O处理机(通道)等支持设备** 。包括各种设备的分配、缓冲区管理、实际物理I/O设备操作，通过管理达到 **提高设备利用率和方便用户的目的** 。

## 1.1 设备管理概述

显示器、鼠标、键盘、打印机、扫描仪、绘图仪、路由器等是现代计算机系统常见的设备。

### 1.1.1 设备分类
1. **按数据组织分类**，分为块设备(Block Device)和字符设备(Character Device)。
    * 块设备: 以数据块为单位来组织和传送数据，如磁盘
    * 字符设备：以单个字符为单位来传送数据的设备，如交互式终端、打印机等

2. **按资源分配角度分类**，分为独占设备、共享设备、虚拟设备。
    * 独占设备：在一段时间内只允许一个进程访问的设备
    * 共享设备：在一段时间内允许多个进程同时访问的设备
    * 虚拟设备：通过虚拟技术将一台独占设备变换为若干台供多个进程共享的逻辑设备。

3. **按数据传输率分类**，分为低速设备、中速设备、高速设备。
    * 低速设备：传输率为每秒几个字节到百个字节。例如，键盘、鼠标等
    * 中速设备：传输速率为每秒数千个字节至数十千个字节。例如，行式打印机、激光打印机等
    * 高速设备：传输速率在数百千字节至数兆字节。例如，磁带机、磁盘机、光盘机等

### 1.1.2 设备管理的目标与任务
1. 设备管理的目标

    提高设备的利用率，为用户提供方便统一的界面。
    * 提高设备的利用率就是提高CPU与输入输出设备之间的并行操作程度，采用技术为**中断技术、DMA技术、通道技术、缓冲技术**
    * 统一的界面是指用户能独立于具体设备的复杂物理特性之外而方便的使用设备。**对不同的设备尽量使用统一的操作方式**。用户操作简便的逻辑设备，具体的物理设备操作由操作系统实现。

2. 设备管理的任务

    多个进程竞争设备时， **按一定的策略分配和管理各种设备，控制设备的各种操作，完成I/O设备于主存之间的数据交换** 。

    设备管理的主要功能时动态掌握并 **记录设备的状态、设备分配和释放、缓冲区管理、实现物理I/O设备的操作、提供设备使用的用户接口和设备的访问于控制** 。

## 1.2 设备管理技术

设备管理技术主要包括**通道、DMA、缓冲、Spooling技术**

1. **通道技术**

    通道的目的是 **使数据的传输独立于CPU** ，将CPU从烦琐的I/O工作中解脱出来。CPU只需要向通道发出输入输出命令，通道收到命令后，从内存中取出本次输入输出要执行的通道程序加以执行，当通道完成输入输出任务后，才向CPU发出中断信号。

    通道价格昂贵，在计算机系统中通道数量有限，成为输入输出的“瓶颈”问题。单通路的I/O系统中主存于设备之间只有一条通路，当通路被设备占用，即使另一通道空闲，连接该通道的其他设备只有等待。为了解决这一“瓶颈”问题，通常增加设备到主机之间的通路，使得主存和设备之间有两条以上的通路。

2. **DMA(直接内存存取)技术**

    数据在内存于输入输出设备之间实现直接成块传送，即是 **在内存于输入输出设备之间传送一个数据块的过程中，只需要CPU在开始(向设备发出“传送一块数据”的命令)与结束(CPU通过轮询或中断得知过程是否结束和下次操作是否准备就绪)时进行处理，**实际操作过程由DMA硬件直接执行完成，CPU在此传送过程中可执行别的任务。

3. **缓冲技术** 

    可以提高外设利用率，尽可能使外设处于忙状态。可以采用**硬件缓冲和软件缓冲**。硬件缓冲是利用专门的硬件寄存器作为缓冲，软件缓冲通过操作系统来管理。缓冲的目的是
    1. 缓和CPU与输入输出设备间速度不匹配

    2. 减少对CPU的中断频率，放宽对中断响应时间的限制

    3. 提高CPU和输入输出设备之间的并行性
    
    输入输出设备与处理机(内存)之间，都使用了缓冲区来交换数据，所以操作系统必须组织和管理好这些缓冲区。缓冲区可分为**单缓冲、双缓冲、多缓冲和环形缓冲**、

4. **Spooling技术**

    Spooling(Simultaneous Peripheral Operation On-Line, 外部设备联机并行操作)是关于慢速字符设备如何与计算机主机交换信息的一种技术，称为“假脱机技术”。**用一类物理设备模拟另一类物理设备，使独占使用的设备变成多台虚拟设备**，也是一种速度匹配技术。Spooling系统由 **“预输入程序”、“缓输出程序”、“井管理程序”及输入和输出井组成。**其中，输入输出井用于存放输入的信息和作业执行的结果，是系统在辅助存储器上开辟的存储区域。

    ![](https://images.gitee.com/uploads/images/2021/0123/190321_3fa25a2e_7841459.jpeg "1611399778707.jpg")
    工作过程是：操作系统初启后激活**预输入程序**，使它处于捕获输入请求的状态，一旦有输入请求消息，**输入程序**立即得到执行，把装在输入设备上的作业输入硬盘的输入井中，并填好作业表以便作业在执行中要求输入信息使，可以随时找到它们的存放位置。当作业需要输出数据时，可以先将数据送到输出井，当输出设备空闲时，由**输出程序**把硬盘上输出井的数据传送到慢速输出设备上。

    Spooling系统中拥有一张作业表，用来登记进入系统的所有作业名、状态和预输入表位置等信息。每个用户作业拥有一张预输入表用来登记该作业的各个文件的情况，包括设备类、信息长度及存放位置等。输入井的作业有4中状态
    1. 输入状态：作业的信息正从输入设备上预输入
    2. 收容状态：作业预输入结束但未被选中执行
    3. 执行状态：作业已被选中运行，运行过程中，它们从输入井中读取数据信息，也可以向输出井写入信息
    4. 完成状态：作业已经撤离，由系统进行善后处理

## 1.3 磁盘调度

磁盘时可以被多个进程共享的设备。当多个进程请求访问磁盘时，为了保证信息的安全，系统 **每一时刻只允许一个进程启动磁盘进行I/O操作** ，其余进程只能等待。为了使进程对磁盘访问的平均时间最小，采用磁盘调度算法有两类**移臂调度和旋转调度**。系统先进行移臂调度，然后进行旋转调度。磁盘调度的目的是**使磁盘的平均寻道时间最少**

### 1.3.1 磁盘驱动调度

常用的磁盘调度算法有**先来先服务、最短寻道时间优先、扫描算法、单向扫描调度算法**
1. 先来先服务(FCFS)。根据进程请求访问磁盘的先后次序进行调度。优点: **简单，公平、每个进程的请求都依次得到处理**，不会出现某进程的请求长期得不到满足的情况。缺点是**平均寻道时间可能较长**

2. 最短寻道时间优先(SSTF)。选择进程时，要求其访问的磁道与当前磁头所在的磁道距离最近，使得每次寻道时间最短。缺点：**不能保证平均寻道时间最短**

3， 扫描算法(SCAN)。不仅考虑到欲访问的磁道与当前磁道的距离，更优先考虑磁头的当前移动方向。又称电梯调度算法

4. 单向扫描调度算法(CSCAN)。SCAN算法存在一个问题: 当磁头刚从里向外移动过某一个磁道时，恰好有一进场请求访问该磁道，此时该进程必须等待，当磁头从里向外，然后再从外向里扫描所要访问的磁道后，才处理该进程的请求。CSCAN算法规定**磁头只做单向移动**

### 1.3.2 旋转调度算法

当移动臂定位后，有多个进程等待访问该柱面，系统应该旋转延迟时间最短的进程对磁盘的扇区进程访问。旋转调度应该考虑如下情况
1. 进程请求访问的是同一磁道上的不同编号的扇区
2. 进程请求访问的是不同磁道上的不同编号的扇区
3. 进程请求访问的是不同磁道上的相同编号的扇区

对于1和2，旋转调度总是让先到达读写磁头位置先得扇区进行传送操作；对于3，旋转调度可以任意选一个读写磁头位置下得扇区进行传送操作。





